---
layout: post
title: "qy-wechat"
description: ""
category: qy-wechat
tags: [qy-wechat]
---
{% include JB/setup %}

# 企业号的配置

## 创建应用

企业号跟目前其他的公众号有两个很大的区别其中之一就是应用，其他公众号在企业号看来就是个应用，而企业号可以有多个应用。
根据目前提供的，企业号有两种应用可以使用，主页型应用和消息型应用
左边菜单栏>>应用中心>>我的应用>>自行创建应用（就是那个+号）

![创建应用](/public/qywechat160123/app-1.png)

点击之后有两个选择

![选择应用](/public/qywechat160123/app-2.png)

如图中所说
个人推荐使用消息型应用，功能比主页型应用多得多，因为在消息型应用中有个回调模式，除了常见的为自动回复设置key还是网页跳转外的事件类型，还提供了扫描推事件，扫描推事件（弹框），系统拍照，拍照与相册，微信发图器，地理位置选择器功能，而主页型只有链接跳转的功能，区别就说到这里，如果搞得明白消息型应用的话主页型也肯定不在话下，下面我就只介绍消息型应用。

![初始化应用-1](/public/qywechat160123/app-3.png)

除了功能介绍可以不填外，其他都需要填写，点击提交后，只要应用不重名，一般都能顺利创建完成的。

## 设置应用

如上面操作即可创建应用，接下来我们讲讲消息型应用的配置。
点击已创建好的应用，就会进入设置界面

![配置应用-1](/public/qywechat160123/set-app-1.png)

![配置应用-2](/public/qywechat160123/set-app-2.png)

如图所示，其中重要的是可信域名，设置的时候不需要填写http和https并只需写到第一级目录就足够了，可信域名最主要是用在oauths的，如果你的域名并不在该应用的可信域名中的话，那你在跳转到该域名的时候肯定是会弹出“redirect_uri参数错误”的，顺便说下“redirect_uri参数错误”出现的原因，无外乎三种，一种就是上面说的没有设置可信域名，一种是在组合好的url中的appid参数不是该公众号的，另一种是该appid并没有权限，这里得说强调一下，在企业号中的appid指的是管理组中的CorpID，所以才会有权限一说，关于CorpID我下面会再说明的。

当然，模式选择也是很重要的一个设置，他有两种模式可选，其中普通模式主要有自动回复和自定义菜单这两个功能，设置都是偏向于图形化界面设置，当然，这也注定他的功能比较局限，相比较而言，回调模式拥有更多的自主权，例如，你可以在用户进行点击菜单栏操作时，动态生成回复语句，甚至将用户的任何操作记录到自己的数据库里等。
点击回调模式会看到如下界面

![配置应用-3](/public/qywechat160123/set-app-3.png)

当然这个是我点击右边开启才会出现现在的可修改界面，点击开启的话会弹出提示系统将关闭普通模式，因为两者共存肯定是有冲突的。

如果没有设置“回调URL及密钥”的话，自定义菜单是无法设置的，我们点击修改

![配置应用-4](/public/qywechat160123/set-app-4.png)

URL为你要处理用户事件的域名，Token和EncodingAESKey建议直接点击随机获取，省得瞎折腾，之后点击保存就行？！当然没这么简单，现在点击很有可能就出现连接超时或者检验错误，因为点击保存时，微信会发get到你所写的url中，你需要将发送的信息进行解密提取，并返回echostr明文才能通过验证，所以我们接着得在你自己的服务器进行配置了，你可以点击图中的

[接口文档](http://qydev.weixin.qq.com/wiki/index.php?title=%E5%9B%9E%E8%B0%83%E6%A8%A1%E5%BC%8F)

来了解如何配置，个人建议直接下载[官方代码](http://qydev.weixin.qq.com/wiki/index.php?title=%E5%8A%A0%E8%A7%A3%E5%AF%86%E5%BA%93%E4%B8%8B%E8%BD%BD%E4%B8%8E%E8%BF%94%E5%9B%9E%E7%A0%81)来，只需要修改里面Token和EncodingAESKey即可，当然你还得了解获取get的参数等知识，这里还要强调一点，如果你用的是java版本的，那你得注意下面的信息

>异常java.security.InvalidKeyException:illegal Key Size的解决方案：
在官方网站下载JCE无限制权限策略文件（请到官网下载对应的版本， 例如JDK7的下载地址：http://www.oracle.com/technetwork/java/javase/downloads/jce-7-download-432124.html )：
下载后解压，可以看到local_policy.jar和US_export_policy.jar以及readme.txt。如果安装了JRE，将两个jar文件放到%JRE_HOME% \lib\security目录下覆盖原来的文件，如果安装了JDK，将两个jar文件放到%JDK_HOME%\jre\lib\security目录下覆盖原来文件。

至于为什么有这问题，是因为jdk默认为有限制权限策略的，无法接收256位密钥，所以才需要替换，至于企鹅为什么要这么做，我只能猜测是为了安全考虑？

如果验证成功后会是下面的界面

![配置应用-5](/public/qywechat160123/set-app-5.png)

本来接着我们接着要说配置自定义菜单的事的，但由于里面会涉及到微信登录的问题，所以我还是先说下管理组的事。

## 管理组设置

左边菜单栏>>设置>>功能设置>>权限管理

![配置管理组-1](/public/qywechat160123/set-manager-1.png)

点击红框

![配置管理组-2](/public/qywechat160123/set-manager-2.png)

点击新建管理组

![配置管理组-3](/public/qywechat160123/set-manager-3.png)

![配置管理组-4](/public/qywechat160123/set-manager-4.png)

这里建议在开发过程中全部选为最高权限。
保存完后会是点击左侧新添加的组就可以看到CorpID和Secret

![配置管理组-5](/public/qywechat160123/set-manager-5.png)

如图所说，这里的CorpID和Secret相当于其他公众号的appId和appSecret，通过这两个值来获取access_token，不同的组合获取的token是不一样的，因为这里有个应用权限在这里，当然得分开哪些token对应用有操作权限，同样，希望通过oauths2来获取code，也会因为设置的appid不同而决定你是否能获取到code

## 配置应用补充

说完管理组，我们补充之前没讲完的自定义菜单。

![配置菜单-1](/public/qywechat160123/set-menu-1.png)

事件类型如此繁多，我们就只讲“菜单key”和“跳转到网页”，

### 菜单key

点击菜单key会要求你写个key值，保存后，当用户点击微信中该按钮时，微信就会把类似下面的xml加密后给post过来

	<xml>
	<ToUserName><![CDATA[toUser]]></ToUserName>
	<FromUserName><![CDATA[FromUser]]></FromUserName>
	<CreateTime>123456789</CreateTime>
	<MsgType><![CDATA[event]]></MsgType>
	<Event><![CDATA[CLICK]]></Event>
	<EventKey><![CDATA[EVENTKEY]]></EventKey>
	<AgentID>1</AgentID>
	</xml>

其中的EVENTKEY就是你之前写给该按钮的key值，你可以根据该EVENTKEY值来决定要怎么处理，你可以返回text，news，或者video给用户，不过有一点得注意，你返回的内容必须加密，具体各类型的格式还有加解密请看[官方文档](http://qydev.weixin.qq.com/wiki/index.php?title=%E8%A2%AB%E5%8A%A8%E5%93%8D%E5%BA%94%E6%B6%88%E6%81%AF)

### 跳转到网页

点击跳转到网页会要求你写上想跳转的url，注意得带上http或者https。
普通的跳转只用把域名或者ip写上就可，但如果希望跳转的同时能获取到用户的信息的话，那就得用下面的形式填写

	https://open.weixin.qq.com/connect/oauth2/authorize?appid=CORPID&redirect_uri=REDIRECT_URI&response_type=code&scope=snsapi_base&state=STATE#wechat_redirect

将其中的CORPID换成管理组中的CORPID（*注意权限*），REDIRECT_URI换成你要跳转的url（*注意该url需要进行urlEncode，而且记得带上http或者https*），其他的可以不用改，当然，如果你想附加信息进去的话，那可以将STATE替换为你要传递的内容（*同样也需要urlencode*）

假设我替换REDIRECT_URI为www.sample.com
保存完之后，用户点击该按钮
那么我们是会先跳转到微信那边，微信根据可信域名和appid来判断是否授予code，通过的话，微信会将code写入url，并将用户推到该url中，该url大致如下

	http://www.sample.com?code=CODDE&state=STATE

之后我们就可以根据url中的code来换取userId（*如果该用户尚未通过管理员验证，那code换取到的是openId*）

## 验证用户

企业号的两大特点中的另一个就是权限，权限部分在管理组那里说了一部分，这里要说下验证用户，如果用户只是单纯的关注企业号的话，那他并不会看到企业小助手外的其他应用，他必须在通讯录上有他的信息，并且得根据他所在组的权限决定他能使用的应用，该权限由应用决定的，也就是上图“创建新应用”的“应用可见范围”中的设置。

点击左上的+号选择新增成员

![验证用户-1](/public/qywechat160123/add-member-1.png)

这里注意下，微信号，手机还有邮箱不能同时为空，这是验证所必须的条件

1.如果只填写的是微信号的话，那用户不需验证直接就能通过（*用户必须绑定了微信号*）

2.如果只填写手机的话，那用户在关注企业号后，在企业小助手任意折腾就会弹出身份验证的链接，点击该链接就会进入验证界面，输入通讯录上保存的手机获取验证码，再通过腾讯发来的短信写入验证码即可完成验证。

3.如果只填写邮箱的话，那用户会在管理员发出邀请的时候收到一封邮件来验证。

还有一点注意，账号必须为所在组唯一的，而我们通过code换取到的userId也就是这个设定的值。








